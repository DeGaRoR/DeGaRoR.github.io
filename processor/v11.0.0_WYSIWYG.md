# v11.0.0 â€” The WYSIWYG Release
## First and Second Law Compliance

**File:** `processThis.html` (single-file simulator, ~29,000 lines)
**Baseline:** v10.9.3, 236 tests (1649 checks), all passing
**Scope:** Energy conservation, mechanical stream removal, port enforcement,
reactor iterative solver

---

## NNG-W: The WYSIWYG Principle

**No Nonsense Given â€” What You See Is What You Get.**

The foundational design principle. Every prior NNG rule is a corollary.

### NNG-W1: Conservation is non-negotiable
Energy and mass are neither created nor destroyed by any unit, under any
condition, including error states. A unit in error may passthrough, but
may not silently consume or produce energy.

### NNG-W2: Unconnected ports carry nothing
An unconnected output port has `actual = 0`. An unconnected input port
provides nothing. No implicit "environment." If you didn't draw the
pipe, the pipe doesn't exist.

### NNG-W3: Trapped energy stays in the fluid
When a unit produces energy (friction, exothermic heat, electrical loss)
and has no connected port to evacuate it, the energy enters the outlet
material stream as additional enthalpy. The outlet gets hotter.

### NNG-W4: Trapped surplus with no fluid path is a failure
When a unit produces non-material energy (electrical surplus) that
cannot be absorbed by any connected path â†’ CRITICAL failure.

### NNG-W5: Demand exists only for electricity
Electrical dispatch (hub, direct-bus, curtailment) is the sole demand-
response mechanism. Heat has no demand propagation. Mechanical streams
do not exist.

### NNG-W6: Setpoints are sizing aids, not physics overrides
A pump's Pout setpoint determines how much power it requests. If the
grid can't deliver, the pump achieves partial pressure.

### NNG-W7: Units compute consequences, not wishes
A reactor's outlet T and conversion are consequences of heat supplied
and thermodynamic equilibrium â€” not user parameters.

---

## Thermodynamic Law Compliance

### First Law (energy conservation)

After v11.0.0, every unit satisfies Î”E = Q + W. No energy created or
destroyed. Specific fixes:

| Unit | Before v11 | After v11 |
|------|-----------|-----------|
| Heater | Caps Q at demand, destroys excess | H_out = H_in + Q_received (all of it) |
| Reactor | heat_starved â†’ Q_out = 0 (destroys Q) | Iterative T-Î¾, all heat in fluid |
| Pump | Via motor (indirect) | Direct elec_in, loss in fluid |
| Compressor | Via motor (indirect) | Direct elec_in, loss in fluid |
| Gas turbine | Via generator (indirect) | Direct elec_out, loss in exhaust |
| Power hub | Surplus â†’ heat_out (wrong type) | Surplus â†’ elec_surplus |

### Second Law (Clausius / entropy)

After v11.0.0, no unit permits heat flow from cold to hot.

**Structural guarantee:** In hard mode, the only HEAT-type streams flow
from electric_heater to heater or reactor. Electricity has no source
temperature â€” converting watts to heat is always thermodynamically valid
regardless of target temperature.

All material-to-material heat transfer goes through the HEX, which already
enforces 2nd law:
- Temperature crossover â†’ MAJOR error (line ~7988)
- Reverse heat flow â†’ CATASTROPHIC error (line ~8006)

All equipment losses (pump, compressor, turbine) heat the fluid â€” entropy
always increases.

Reactor equilibrium at T_out guarantees Î”G â‰¤ 0 by construction.

**HEAT-type port inventory (hard mode after v11):**

| Unit | Port | Direction | 2nd law concern? |
|------|------|-----------|-----------------|
| Electric heater | heat_out | OUT | No (electricity â†’ heat) |
| Heater | heat_in | IN | No (receives electrical heat) |
| Reactor (heated) | heat_in | IN | No (receives electrical heat) |

No thermal-source heat_out exists in hard mode. Zero 2nd law gaps.

---

## Phase Overview

```
Phase 1 â”€â”€â”€ Fix Energy Violations â”€â”€â”€â”€â”€â”€â”€â”€ Gate: 242 tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Phase 2 â”€â”€â”€ Delete Mechanical Stream â”€â”€â”€â”€â”€ Gate: 241 tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Phase 3 â”€â”€â”€ WYSIWYG Port Enforcement â”€â”€â”€â”€ Gate: 248 tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Phase 4 â”€â”€â”€ Hub Surplus + Demo + Import â”€â”€ Gate: 253 tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Phase 5 â”€â”€â”€ Reactor Modes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Gate: 262+ tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Each phase gated: ALL tests green before proceeding.

---

## Phase 1: Fix Energy Violations

**Goal:** No unit destroys or creates energy, under any condition.

### 1a. Heater â†’ dumb heat pipe

The heater currently computes T_setpoint from par.T_out, derives Q_demand,
and caps Q_actual at min(Q_demand, Q_supplied). Excess heat vanishes.

**Root cause:** v10.4.2 removed backward-propagating heatDemand system but
left the heater's internal demand logic intact.

**Delete from heater tick (line ~9737â€“9764):**
- `par.T_out` parameter definition
- `T_setpoint_K` computation
- `Q_demand_W` computation
- `Math.min(Q_demand_W, heatActual_W)` capping
- `supplyLimited` flag

**Delete from inspector (line ~18178â€“18188):**
- "Q demand" display
- "T setpoint" display

**New tick logic:**
```javascript
const Q_W = sHeat ? (sHeat.actual ?? 0) : 0;
if (!sHeat) {
  // Unconnected: passthrough, MAJOR error
  ports.mat_out = { ...sIn };
  u.last = { error: { severity: 'MAJOR', message: 'No heat source connected' },
             Q_actual_W: 0 };
  return;
}
const H_in = thermo.getHdot_Jps(sIn);
const H_out = H_in + Q_W;
ports.mat_out = { type: StreamType.MATERIAL, P: sIn.P,
  n: { ...sIn.n }, phaseConstraint: sIn.phaseConstraint,
  H_target_Jps: H_out };
u.last = { Q_actual_W: Q_W };
```

**Tests modified:**
- T24 (Heater Nâ‚‚): Remove T_out setpoint assertion. Assert H_outâˆ’H_in = Q.
- T25 (Heater Hâ‚‚O boiling): Same. Verify phase change at known Q.
- T95 (Exception containment): Update if heat source chain changed.

**New tests:**
- **T237:** Supply 30 kW to heater. Verify Q_actual = 30 kW,
  H_out âˆ’ H_in = 30 kW (Â±1 W), T_out is consequence. Zero residual.
- **T238:** No heat_in connected. Verify Q_actual = 0, T_out = T_in,
  MAJOR error emitted, zero energy created.
- **T239:** Supply 1 W, 1 kW, 100 kW sequentially. Verify each:
  H_out âˆ’ H_in = Q_supplied exactly. No capping at any level.

### 1b. Reactor isothermal â€” fix heat_starved energy destruction

When endothermic + insufficient heat, reactor sets Q_out_W = 0 but received
Q_supplied > 0. That heat vanishes (line ~10895).

**Change:** `Q_out_W = 0` â†’ `Q_out_W = Q_supplied_W`

Reaction still doesn't proceed (passthrough), but supplied energy exits
heat_out instead of being destroyed.

**New tests:**
- **T240:** Endothermic + 1 kW supplied to 8 kW duty. Verify:
  status = heat_starved, Q_out = 1 kW, mat_out = inlet, 0 residual.
- **T241:** Endothermic + 50 kW supplied to 8 kW duty. Verify:
  Q_out = 42 kW (surplus), reaction proceeds. 0 residual.
- **T242:** Exothermic + 10 kW supplied. Verify:
  Q_out = Q_released + 10 kW. 0 residual.

### 1c. Demo maxPower fix

`a-hgrid` in demo scene has `maxPower: 30000`. The grid_supply tick
multiplies by 1000 (parameter is in kW), giving 30,000 kW = 30 MW.
Should be `maxPower: 30` for 30 kW.

### Gate 1
```
Tests: 242 (236 existing + 6 new, 3 modified)
Verify: grep "Q_demand" in heater tick â†’ 0 hits
Verify: grep "T_setpoint" in heater tick â†’ 0 hits
Verify: grep "supplyLimited" in heater tick â†’ 0 hits
```

---

## Phase 2: Delete Mechanical Stream

**Goal:** One non-material energy type: electrical. Pump/compressor/turbine
connect directly to the grid. Motor, generator, source_mechanical deleted.

### 2a. Pump: `power_in` (MECHANICAL) â†’ `elec_in` (ELECTRICAL)

**Port definition change** in UnitRegistry.register('pump', ...):
Replace `{ portId: 'power_in', type: StreamType.MECHANICAL, ... }`
with `{ portId: 'elec_in', type: StreamType.ELECTRICAL, ... }`

**Tick change:** Read `ports.elec_in.actual` instead of mechanical port.
Set `u.powerDemand` directly (no motor intermediary). Inefficiency already
goes into fluid via `computePumpWork` (H_target includes friction heat).

**Presentation variants:** Update portId in all pump presentations.

**Tests modified:** "Water Pump (Hydraulic Work)" â€” replace
`source_mechanical â†’ motor â†’ pump.power_in` with
`grid_supply â†’ pump.elec_in`.

**New tests:**
- **T243:** grid_supply â†’ pump.elec_in. Verify Pout achieved,
  powerDemand = W_hydraulic/Î·, H_out âˆ’ H_in = W_electrical. 0 residual.
- **T244:** Undersized grid â†’ pump curtailed. Verify partial Pout,
  all supplied electricity accounted in fluid enthalpy. 0 residual.
- **T245:** Pump with unconnected elec_in â†’ passthrough at P_in, MAJOR.

### 2b. Compressor: same pattern as pump

`power_in` (MECHANICAL) â†’ `elec_in` (ELECTRICAL). Default Î· = 0.80.
All inefficiency stays in gas as extra enthalpy.

**Tests modified:** "Nitrogen Compressor", "Oxygen Compressor (Low T)".

**New tests:**
- **T246:** grid_supply â†’ compressor.elec_in. Same verifications as T243.
- **T247:** Compressor curtailed. Same as T244.

### 2c. Gas turbine: `mech_out` â†’ `elec_out` (ELECTRICAL)

Default Î· = 0.85 (absorbs generator loss). `W_elec = W_shaft Ã— Î·`.
Loss stays in exhaust (hotter outlet). Port writes capacity/actual/available
for hub dispatch.

**Tests modified:** "Gas Turbine: Nâ‚‚ Expansion", "Turbine+Gen â†’ Hub Producer".

**New test:**
- **T248:** Verify W_elec = W_shaft Ã— Î·, exhaust H = H_in âˆ’ W_shaft
  (loss stays in fluid, not lost). 0 residual.

### 2d. Delete motor, generator, source_mechanical

**Delete UnitRegistry.register() blocks (~130 lines total):**
- `motor` registration + tick
- `generator` registration + tick
- `source_mechanical` registration + tick

**Delete solver code:**
- Step B motor demand block (~30 lines) â€” searches for motors downstream
  of power consumers to propagate demand
- Step E source_mechanical dispatch (~50 lines)

**Delete `StreamType.MECHANICAL`** from enum (~line 5600).

**Delete SVG icons:** `ico-motor`, `ico-generator` (~40 lines).

**Delete/update diagnostics:**
- Unconnected heat_out warning list (line ~13286): remove motor/generator
- Power cycle detection: simplify (fewer unit types)

**Tests deleted (8):**
```
Motor+Compressor Demand           Turbine + Generator Chain
Hub-to-Hub: Motor Between Hubs    Motor: Energy Balance
Generator: Energy Balance         Motor: Heat Sink Connected
Motor+Generator: Unconnected Heat  No converge-to-zero (motors)
```

**Tests modified (29):** All tests using motor as intermediary. Replace
`gridâ†’motorâ†’X.power_in` with `gridâ†’X.elec_in`. Replace
`turbine.mech_outâ†’genâ†’sink` with `turbine.elec_outâ†’sink`. Full list in
Appendix A.

**New test:**
- **T249:** Verify StreamType enum has exactly MATERIAL, ELECTRICAL, HEAT.
  Grep production code for MECHANICAL, motor, generator, source_mechanical
  â†’ 0 hits.

### Gate 2
```
Tests: 241 (242 âˆ’ 8 deleted + 7 new, 29 modified)
Verify: grep "MECHANICAL" in production code â†’ 0
Verify: grep "'motor'" in production code â†’ 0
Verify: grep "'generator'" in production code â†’ 0
Verify: grep "source_mechanical" in production code â†’ 0
Verify: grep "mech_out\|mech_in\|power_in" in unit registrations â†’ 0
```

---

## Phase 3: WYSIWYG Port Enforcement

**Goal:** Unconnected ports carry nothing. Trapped energy stays in fluid.
The "dissipated" energy balance category dies.

### 3a. Reactor isothermal: NNG-W2/W3 for heat_out

This is an interim fix for the isothermal reactor until Phase 5 removes
heat_out entirely. If `heat_out` unconnected:

- **Exothermic:** Set `H_target_Jps = H_in` on mat_out (energy conserved).
  PH-flash gives T_out. MINOR warning: "heat_out unconnected â€” exothermic
  heat retained in fluid."
- **Endothermic + surplus:** surplus stays in fluid similarly.

If `heat_out` connected: current isothermal behavior unchanged.

Note: Î¾ is still evaluated at T_in (isothermal assumption). T_out differs
from T_in but energy is conserved. Phase 5 makes Î¾ and T_out fully
self-consistent.

**New tests:**
- **T250:** Exothermic + heat_out connected â†’ Q exits port. 0 residual.
- **T251:** Exothermic + heat_out unconnected â†’ H_out = H_in,
  T_out > T_isothermal. 0 residual. MINOR warning present.
- **T252:** Endothermic + surplus + unconnected â†’ surplus in fluid.

### 3b. Electric heater: no load â†’ no draw

If `heat_out` not connected: `powerDemand = 0`, draws nothing.
MAJOR warning: "No heat load connected."

**Implementation:** Electric heater already checks `hasElecIn` in Step B.
Add parallel check for heat_out connections.

**New tests:**
- **T253:** heat_out connected â†’ draws power, outputs heat. Normal.
- **T254:** heat_out unconnected â†’ powerDemand = 0, draws 0 W, MAJOR.

### 3c. Delete "dissipated" energy balance category

Remove `energyOut.dissipated` from balance computation (line ~13543â€“13554).
Remove from total energy equation. After 3a/3b, no unit writes nonzero
actual to an unconnected heat_out, so this category captures nothing.

**Tests modified:**
- "MASTER: Energy Balance â€” Unconnected Heat (Dissipated)" â†’ rewrite to
  verify energy stays in fluid, not dissipated.
- "Balance report â€” ALL unit types" â†’ remove dissipated field.

**New tests:**
- **T255:** Balance report has no "dissipated" field anywhere.
- **T256:** Full system with unconnected exothermic reactor â†’ 0 residual,
  exothermic heat visible as higher H_out on material sink.

### Gate 3
```
Tests: 248 (241 + 7 new, 2 modified)
Verify: grep "dissipated" in energy balance code â†’ 0
```

---

## Phase 4: Hub Surplus + Demo + Migration

**Goal:** Hub surplus is electrical. Demo scene clean. Old saved scenes
auto-migrate.

### 4a. Power hub: `heat_out` â†’ `elec_surplus` (ELECTRICAL)

**Port change:** Replace `heat_out` (HEAT) with `elec_surplus` (ELECTRICAL).

Surplus computation unchanged. Output type changes.

- Connected + surplus: flows out to downstream load.
- Unconnected + surplus > tolerance: CRITICAL: "Electrical surplus X.X kW
  â€” no dump load connected."
- No surplus: port carries 0, no error.

**Tests modified:** All hub tests referencing heat_out â†’ elec_surplus.

**New tests:**
- **T257:** Hub surplus â†’ elec_surplus connected â†’ surplus flows out.
- **T258:** Hub surplus â†’ elec_surplus unconnected â†’ CRITICAL.
- **T259:** Hub no surplus â†’ unconnected â†’ no error, port = 0.

### 4b. Demo scene update

**Delete units (4):** a-motor, a-gen, c-motor, sink_heat-1

**Rewire (3):**
- a-grid.out â†’ a-comp.elec_in (was: a-grid â†’ a-motor â†’ a-comp.power_in)
- a-turb.elec_out â†’ a-eout (was: a-turb.mech_out â†’ a-gen â†’ a-eout)
- c-grid.out â†’ c-pump.elec_in (was: c-grid â†’ c-motor â†’ c-pump.power_in)

**Parameters:**
- a-hgrid maxPower: 30 (fixed in Phase 1c)
- a-eheat power_kW: 8 (match actual combustor need, was 30)

**Hub:** Connect hub elec_surplus to sink_electrical.

**Demo version:** Bump version string to force localStorage refresh.

**Result:** 38 units (was 42).

### 4c. importJSON migration handler

For scenes saved with version < v11.0.0:

**Motor removal:**
```
For each unit where defId === 'motor':
  Find connection A â†’ motor.elec_in
  Find connection motor.mech_out â†’ B.power_in
  Create: A â†’ B.elec_in
  Delete: motor unit + both old connections + motor.heat_out connections
```

**Generator removal:**
```
For each unit where defId === 'generator':
  Find connection A.mech_out â†’ generator.mech_in
  Find connection generator.elec_out â†’ B
  Create: A.elec_out â†’ B
  Delete: generator unit + both old connections + heat_out connections
```

**source_mechanical removal:** Delete unit + all connections.

**Port renames in connections:**
- `power_in` â†’ `elec_in` in `to.portId`
- `mech_out` â†’ `elec_out` in `from.portId`
- `heat_out` â†’ `elec_surplus` on hub units in `from.portId`

**Parameter cleanup:**
- Strip `par.T_out` from all heater units
- Strip `par.mode` if set to old values

**Version stamp:** Update `version` field in exported JSON.

**New tests:**
- **T260:** Import scene with motor chain â†’ loads with direct electrical,
  no motor/gen in scene, solver runs clean.
- **T261:** Import scene with heater T_out param â†’ param stripped.

### 4d. T236 demo integration rewrite

T236 tests the demo scene end-to-end. Must match new topology.

### Gate 4
```
Tests: 253 (248 + 5 new, hub tests + T236 modified)
Verify: Demo energy balance residual < 0.1 kW
```

---

## Phase 5: Reactor Modes (Adiabatic + Heated)

**Goal:** Two reactor modes sharing an iterative T-Î¾ solver. Isothermal
becomes a readout. Old cheat `reactor_adiabatic` retired.

### Background

A CSTR has one temperature: T_out. The energy balance is:

```
H(T_out, n_eq(T_out)) = H_in + Q_in
```

One equation, one unknown. Bisect on T_out until equilibrium and enthalpy
balance are simultaneously satisfied.

The current isothermal model is the special case where T_out = T_in is
assumed and Q_duty is reported as the consequence. It is correct when heat
management maintains T_in. The iterative solver generalizes to any Q_in.

**Prototype results** (SMR, CHâ‚„+2Hâ‚‚O at 1000K, 20 bar):

| Q_in (kW) | T_out (K) | Conversion | Description |
|-----------|-----------|-----------|-------------|
| 0 | 854 | 11.9% | Adiabatic |
| 4 | ~900 | ~15% | Partial heat |
| 8.35 | 1000 | 22.2% | = isothermal |
| 20 | ~1100 | ~30% | Excess heat |

Converged in ~15 bisection iterations. Verified with real thermo.

### 5a. Reactor mode selector

Two modes via `par.mode`:

**`adiabatic` (default)**
- No heat ports (hidden, connections rejected with MAJOR error).
- Iterative T-Î¾ solver with Q_in = 0.
- T_out < T_in for endothermic, T_out > T_in for exothermic.
- Player manages temperature with upstream heaters, downstream HEX/coolers.
- Replaces old `reactor_adiabatic` cheat unit.

**`heated`**
- heat_in port active (external heat supply). No heat_out port.
- Models reactor with internal heating coils / jacket / fired shell.
- Iterative T-Î¾ solver with Q_in = heat_in.actual (or 0 if unconnected).
- All reaction heat stays in fluid. Supplied heat also stays in fluid.
- When Q_in = 0: identical to adiabatic.
- When Q_in = Q_duty_isothermal: recovers isothermal performance exactly.

**Isothermal readout (both modes)**
- Not a mode. A diagnostic number in the inspector.
- Computes: "If perfectly isothermal at T_in, Q_duty = X kW, conv = Y%."
- Helps player size heat supply. Labeled "Isothermal reference (indicative)."

### 5b. The CSTR equation

```
H(T_out, n_eq(T_out)) = H_in + Q_in
```

| Mode | Q_in | Heat ports | Solver |
|------|------|-----------|--------|
| Adiabatic | 0 | None | Bisect on T_out |
| Heated | heat_in.actual | heat_in only | Bisect on T_out |

No heat_out in either mode. All energy exits via mat_out.

**Bisection procedure (both modes):**
```
T_lo = max(300, Tmin_activation)
T_hi = min(3000, Tmax_activation + 500)
H_target = H_in + Q_in

For up to 80 iterations:
  T_mid = (T_lo + T_hi) / 2
  Î¾_eq = equilibrium_xi_at(T_mid)     // inner bisection, ~60 steps
  Î¾ = Î¾_eq Ã— alpha(kinetics, volume)  // kinetic scaling
  n_out = apply_stoich(n_in, Î¾)
  H_out = getHdot_Jps(T_mid, P, n_out)
  residual = H_out - H_target
  if |residual| < 0.5 W: converged
  if residual > 0: T_hi = T_mid  // too hot
  else: T_lo = T_mid              // too cold
```

### 5c. Performance and convergence

**Cost:** ~15 outer iterations Ã— (60 arithmetic + 1 flash) â‰ˆ 15 flash calls.
Current isothermal: 2 flashes. Overhead: ~7.5Ã— per reactor tick. Acceptable
for a scene with 2â€“3 reactors.

**Convergence:** H(T, n_eq(T)) is monotonically increasing in T. Bisection
on a monotonic function converges unconditionally. At activation window
boundaries, Î¾ = 0, H still monotonic via Cp. No convergence risk.

**Failsafe:** 80 iterations without convergence â†’ MAJOR warning, passthrough.

### 5d. Retire reactor_adiabatic (cheat)

Old `reactor_adiabatic`: cheat=true, fixed conversion, no equilibrium.
Superseded by equilibrium reactor in adiabatic mode.

- Remove from UnitRegistry
- Remove from category listing
- importJSON migration: `reactor_adiabatic` â†’ `reactor_equilibrium` with
  `mode: 'adiabatic'`, conversion param dropped with console warning

### 5e. Remove reactor heat_out port

The equilibrium reactor's `heat_out` port is removed in both modes. All
energy exits via mat_out. This eliminates the temperatureless-heat-stream
problem entirely.

Phase 3a (interim NNG-W2/W3 for heat_out) code is stripped â€” no heat_out
means no unconnected-heat_out scenario to handle.

**Presentation variants:** All reactor presentations updated to remove
heat_out port positioning.

### 5f. Inspector updates

Mode selector: dropdown (Adiabatic / Heated).

Both modes show: T_out, Î¾, conversion, Î”T = T_out âˆ’ T_in, iterations.
Heated mode adds: Q_supplied.
Both modes show isothermal readout: Q_duty_isothermal, Î¾_isothermal,
labeled "Isothermal reference (indicative)."

### 5g. Tests

- **T262:** Adiabatic SMR â†’ T_out â‰ˆ 854K, conv â‰ˆ 11.9%, H balanced.
- **T263:** Heated SMR, Q = 4 kW â†’ T_out between 854â€“1000K.
- **T264:** Heated SMR, Q = 8.35 kW â†’ T_out â‰ˆ 1000K, conv â‰ˆ 22.2%.
- **T265:** Heated SMR, Q = 20 kW â†’ T_out > 1000K, conv > 22.2%.
- **T266:** Adiabatic Sabatier (exo) â†’ T_out > T_in, conv limited.
- **T267:** Heated exo, heat_in unconnected â†’ identical to adiabatic.
- **T268:** Isothermal readout matches legacy isothermal calculation.
- **T269:** Adiabatic mode rejects heat_in connection â†’ MAJOR error.
- **T270:** Heated mode, heat_in unconnected â†’ Q=0, same as adiabatic.
- **T271:** Convergence failsafe â€” pathological feed â†’ graceful passthrough.
- **T272:** Migration: old reactor_adiabatic â†’ reactor_equilibrium(adiabatic).
- **T273:** No heat_out port on reactor_equilibrium in any mode.

### Gate 5
```
Tests: 262+ (253 + 12 new, old reactor_adiabatic tests migrated)
Verify: reactor_adiabatic not in production code
Verify: No heat_out on reactor_equilibrium
Verify: Heated at Q=Q_duty recovers isothermal result (T within 1K)
Verify: Adiabatic at Q=0 â†’ T_out â‰ˆ 854K for SMR
Verify: Isothermal readout shown in inspector for all modes
```

---

## Verification Checklist â†’ Test Mapping

### Phase 1 â€” Energy Conservation

| # | Claim | Test | Gate |
|---|-------|------|------|
| 1 | Heater: Q_actual = Q_supplied, no cap | T237 | 1 |
| 2 | Heater: no heat_in â†’ passthrough, Q=0 | T238 | 1 |
| 3 | Heater: accepts any Q without capping | T239 | 1 |
| 4 | Reactor: heat_starved â†’ Q_out = Q_supplied | T240 | 1 |
| 5 | Reactor: sufficient â†’ surplus on heat_out | T241 | 1 |
| 6 | Reactor: exo + supplied â†’ all exits | T242 | 1 |
| 7 | No Q_demand in heater code | T237 + grep | 1 |
| 8 | No T_setpoint in heater code | T237 + grep | 1 |

### Phase 2 â€” Mechanical Deletion

| # | Claim | Test | Gate |
|---|-------|------|------|
| 9 | Pump: direct elec_in, H balanced | T243 | 2 |
| 10 | Pump: curtailed â†’ partial, 0 residual | T244 | 2 |
| 11 | Pump: no elec_in â†’ passthrough + MAJOR | T245 | 2 |
| 12 | Compressor: direct elec_in | T246-7 | 2 |
| 13 | Turbine: elec_out = W_shaft Ã— Î· | T248 | 2 |
| 14 | No MECHANICAL anywhere | T249 | 2 |

### Phase 3 â€” WYSIWYG Port Enforcement

| # | Claim | Test | Gate |
|---|-------|------|------|
| 15 | Reactor exo + heat_out connected â†’ Q exits | T250 | 3 |
| 16 | Reactor exo + heat_out unconnected â†’ in fluid | T251 | 3 |
| 17 | Reactor endo surplus + unconnected â†’ in fluid | T252 | 3 |
| 18 | E-heater heat_out connected â†’ normal | T253 | 3 |
| 19 | E-heater heat_out unconnected â†’ draws 0 | T254 | 3 |
| 20 | No "dissipated" in balance code | T255 | 3 |
| 21 | System balance, unconnected â†’ 0 residual | T256 | 3 |

### Phase 4 â€” Hub + Demo + Migration

| # | Claim | Test | Gate |
|---|-------|------|------|
| 22 | Hub surplus â†’ elec_surplus connected â†’ flows | T257 | 4 |
| 23 | Hub surplus â†’ unconnected â†’ CRITICAL | T258 | 4 |
| 24 | Hub no surplus â†’ no error | T259 | 4 |
| 25 | Import migration: motor â†’ direct elec | T260 | 4 |
| 26 | Import migration: heater T_out stripped | T261 | 4 |
| 27 | Demo balance < 0.1 kW | T236 | 4 |

### Phase 5 â€” Reactor Modes

| # | Claim | Test | Gate |
|---|-------|------|------|
| 28 | Adiabatic: T-Î¾ self-consistent, H balanced | T262 | 5 |
| 29 | Heated partial: between adiabatic and iso | T263 | 5 |
| 30 | Heated at Q_duty: recovers isothermal | T264 | 5 |
| 31 | Heated excess: T > T_in, conv > iso | T265 | 5 |
| 32 | Adiabatic exothermic: T rises, conv limited | T266 | 5 |
| 33 | Heated exo, no heat_in â†’ adiabatic | T267 | 5 |
| 34 | Isothermal readout matches legacy | T268 | 5 |
| 35 | Adiabatic rejects heat_in | T269 | 5 |
| 36 | Heated + no heat_in = adiabatic | T270 | 5 |
| 37 | Convergence failsafe | T271 | 5 |
| 38 | Migration: old adiabatic â†’ equilibrium | T272 | 5 |
| 39 | No heat_out port on reactor | T273 | 5 |

**39 claims, 37 new tests (T237â€“T273), 0 uncovered.**

---

## Post-v11.0.0 System Summary

### Stream types: MATERIAL, ELECTRICAL, HEAT

### Energy consumers (electrical demand):

| Unit | powerDemand | Curtailment fallback |
|------|------------|---------------------|
| Pump | W_hydraulic / Î· | Partial pressure |
| Compressor | W_isentropic / Î· | Partial compression |
| Electric heater | power_kW Ã— 1000 | Reduced heat |

### Energy producers:

| Unit | Output type | Notes |
|------|-----------|-------|
| Grid supply | Electrical | Demand-responsive or fixed |
| Battery | Electrical | SOC-tracked |
| Gas turbine | Electrical | Loss in exhaust (mat_out) |

### Reactor modes:

| Mode | Heat ports | Solver | Use case |
|------|-----------|--------|----------|
| Adiabatic | None | Iterative T-Î¾ | Default. Manage T externally |
| Heated | heat_in only | Iterative T-Î¾ | Internal heating coils/jacket |

Isothermal Q_duty shown as readout in all modes (indicative, not a mode).

### Balance equation:

```
Î£(material + electrical + heat)_in
= Î£(material + electrical + heat)_out
+ Î£ accumulation
+ residual (â‰ˆ 0)
```

No "dissipated." No "mechanical." No demand-capping. No temperatureless
thermal heat_out in hard mode.

### Code impact estimate:

| Change | Lines deleted | Lines added | Net |
|--------|-------------|-------------|-----|
| Motor/gen/source_mech | ~130 | 0 | âˆ’130 |
| Step B motor + Step E | ~80 | 0 | âˆ’80 |
| StreamType.MECHANICAL | ~5 | 0 | âˆ’5 |
| SVG icons | ~40 | 0 | âˆ’40 |
| Dissipated balance | ~15 | 0 | âˆ’15 |
| Heater demand logic | ~30 | ~10 | âˆ’20 |
| Pump/comp/turb ports | ~10 | ~10 | 0 |
| Hub heat_outâ†’elec_surplus | ~5 | ~5 | 0 |
| Reactor iterative solver | 0 | ~80 | +80 |
| Reactor mode selector | 0 | ~30 | +30 |
| Migration handler | 0 | ~60 | +60 |
| **Total** | **~315** | **~195** | **âˆ’120** |

---

## Appendix A: Tests Modified in Phase 2d

29 tests using motor/generator as intermediary. Replace wiring pattern:

| Old pattern | New pattern |
|------------|-------------|
| grid â†’ motor â†’ X.power_in | grid â†’ X.elec_in |
| X.mech_out â†’ generator â†’ sink | X.elec_out â†’ sink |

```
Nitrogen Compressor                    Water Pump (Hydraulic Work)
Oxygen Compressor (Low T)              Converters Need Elec Input
Hub: Sufficient Supply                 Hub: Curtailment
Compressor: Curtailed Outlet           Grid Supply: Direct Shortage
Hub: Proportional Curtailment          Gas Turbine: N2 Expansion
Turbine+Gen â†’ Hub Producer             Hub: Per-Consumer Allocation
Power Cycle: connect() Rejects Loop    Power Cycle: Solver Imported
Hub-to-Hub: Blocked in Realistic       MASTER: System Energy Balance
MASTER: Unconnected Heat               Per-Unit Mass Balance (kg/s)
Per-Unit Energy Balance (W)            Graph: Power-only excl. SCCs
RuntimeContext: solve twice             Direct elec fanout curtails
Direct battery fanout curtails         Solver integration monkeypatch
Power semantic model â€” fanout          Hub allocation â€” per-consumer
normalizeNonMaterialStream             Balance report â€” ALL types
SimSettings â€” listByCategory
```

## Appendix B: Tests Deleted in Phase 2d

8 tests whose subjects no longer exist:

```
Motor+Compressor Demand                Turbine + Generator Chain
Hub-to-Hub: Motor Between Hubs         Motor: Energy Balance
Generator: Energy Balance              Motor: Heat Sink Connected
Motor+Generator: Unconnected Heat       No converge-to-zero (motors)
```

## Appendix C: Risk Assessment

| Phase | Risk | Mitigation |
|-------|------|------------|
| 1 | T24, T25 tests rely on T_out setpoint | Rewrite: verify T_out as consequence |
| 2 | 29 tests need rewiring | Mechanical substitution only |
| 2 | Power cycle detection simplification | Fewer unit types = simpler graph |
| 3 | Reactor needs connection awareness | Solver post-processing pattern |
| 3 | Dissipated removal breaks balance UI | Update report template |
| 4 | importJSON edge cases | Test motor-only, gen-only, mixed, empty |
| 4 | Demo layout after unit deletion | Re-export from user |
| 5 | Iterative solver perf | 7.5Ã— per reactor, acceptable |
| 5 | Phase boundary flash noise | Existing solver handles this |
| 5 | reactor_adiabatic migration | Conversion param dropped with warning |

---

<!-- PHASE TRACKER â€” update statuses here after each phase -->
<!-- Status: â¬œ TODO â”‚ ðŸ”¨ ACTIVE â”‚ âœ… DONE â”‚ â¸ï¸ BLOCKED -->

## Phase Tracker

| Ph | Step | Description | Status | Tests | Gate |
|----|------|-------------|--------|-------|------|
| 1 | a | Heater â†’ dumb pipe | â¬œ | +T237-239, mod T24,T25,T95 | |
| 1 | b | Reactor heat_starved fix | â¬œ | +T240-242 | |
| 1 | c | Demo maxPower fix | â¬œ | mod T236 | |
| | | **GATE 1** | â¬œ | **242 tests, 0 fail** | Q_demand gone |
| 2 | a | Pump elec_in | â¬œ | +T243-245, mod pump tests | |
| 2 | b | Compressor elec_in | â¬œ | +T246-247, mod comp tests | |
| 2 | c | Gas turbine elec_out | â¬œ | +T248, mod turb tests | |
| 2 | d | Delete mech system | â¬œ | +T249, âˆ’8, mod 29 | |
| | | **GATE 2** | â¬œ | **241 tests, 0 fail** | No MECHANICAL |
| 3 | a | Reactor NNG-W2/W3 interim | â¬œ | +T250-252 | |
| 3 | b | E-heater no load â†’ no draw | â¬œ | +T253-254 | |
| 3 | c | Delete dissipated category | â¬œ | +T255-256, mod balance tests | |
| | | **GATE 3** | â¬œ | **248 tests, 0 fail** | No dissipated |
| 4 | a | Hub elec_surplus | â¬œ | +T257-259, mod hub tests | |
| 4 | b | Demo scene update | â¬œ | mod T236 | |
| 4 | c | importJSON migration | â¬œ | +T260-261 | |
| 4 | d | T236 integration rewrite | â¬œ | mod T236 | |
| | | **GATE 4** | â¬œ | **253 tests, 0 fail** | Demo balanced |
| 5 | a | Mode selector (adiabatic/heated) | â¬œ | | |
| 5 | b | Iterative T-Î¾ solver | â¬œ | +T262-268 | |
| 5 | c | Adiabatic mode + port hiding | â¬œ | +T269-270 | |
| 5 | d | Convergence failsafe | â¬œ | +T271 | |
| 5 | e | Retire reactor_adiabatic | â¬œ | +T272, mod old tests | |
| 5 | f | Remove reactor heat_out | â¬œ | +T273 | |
| 5 | g | Inspector + isothermal readout | â¬œ | | |
| | | **GATE 5 (FINAL)** | â¬œ | **262+ tests, 0 fail** | 1st+2nd law |
